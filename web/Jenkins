pipeline {
    agent any

    environment {
        SERVER_IP = '4.217.199.31'
        SERVER_USER = 'Suphanat'
        PROJECT_PATH = '/var/www/html/smart-paddy'
        CREDENTIAL_ID = 'vps-ssh-key' 
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà GIT_URL ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Jenkins ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Job ‡πÅ‡∏•‡πâ‡∏ß
    }

    stages {
        stage('Deploy to Server') {
            steps {
                sshagent([CREDENTIAL_ID]) {
                    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
                    sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'mkdir -p ${PROJECT_PATH}'"
                    
                    // 2. ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏õ (‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Docker Build)
                    // ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á node_modules ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÑ‡∏õ install ‡πÉ‡∏ô Docker ‡πÄ‡∏≠‡∏≤
                    sh "rsync -avz --exclude '.git' --exclude 'node_modules' --exclude '.next' ./ ${SERVER_USER}@${SERVER_IP}:${PROJECT_PATH}"
                }
            }
        }

        stage('Docker Build & Run') {
            steps {
                sshagent([CREDENTIAL_ID]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} '
                            cd ${PROJECT_PATH}
                            
                            echo "üê≥ Building new image..."
                            # ‡∏™‡∏±‡πà‡∏á Docker Compose ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (-d ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏±‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á, --build ‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
                            docker compose up -d --build
                            
                            echo "üßπ Cleaning old images..."
                            # ‡∏•‡∏ö Image ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                            docker image prune -f
                        '
                    """
                }
            }
        }
    }
}