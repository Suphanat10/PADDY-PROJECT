pipeline {
    agent any

    environment {
        SERVER_IP = '4.217.199.31'
        SERVER_USER = 'Suphanat'
        // ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ö‡∏ô Server
        PROJECT_BASE_PATH = '/var/www/html/smart-paddy' 
        CREDENTIAL_ID = 'vps-ssh-key' 
    }

    stages {
        stage('Deploy Files') {
            steps {
                sshagent([CREDENTIAL_ID]) {
                    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ö‡∏ô Server
                    sh "ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} 'mkdir -p ${PROJECT_BASE_PATH}'"
                    
                    // 2. ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏≤‡∏Å Root ‡∏Ç‡∏≠‡∏á Git) ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
                    // rsync ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå web ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    sh "rsync -avz --exclude '.git' --exclude 'node_modules' --exclude '.next' ./ ${SERVER_USER}@${SERVER_IP}:${PROJECT_BASE_PATH}"
                }
            }
        }

        stage('Build & Run Docker') {
            steps {
                sshagent([CREDENTIAL_ID]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} '
                            # ‚ö†Ô∏è ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á cd ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô web ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á Docker
                            cd ${PROJECT_BASE_PATH}/web
                            
                            echo "üê≥ Building Docker Image..."
                            docker compose up -d --build
                            
                            echo "üßπ Cleaning up..."
                            docker image prune -f
                        '
                    """
                }
            }
        }
    }
}