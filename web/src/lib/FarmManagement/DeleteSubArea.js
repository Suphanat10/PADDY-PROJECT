import { apiFetch } from "@/lib/api";
import Swal from "sweetalert2";

export async function DeleteSubArea(
  farm_id,
  sub_area_id,
  setIsDeleting,
  currentFarmForSubArea,
  setCurrentFarmForSubArea,
  setFarms
) {

  if (!farm_id || !sub_area_id) {
    Swal.fire({
      icon: "warning",
      title: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢",
      text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö",
    });
    return;
  }

  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏•‡∏ö‡∏ã‡πâ‡∏≥

  const confirm = await Swal.fire({
    title: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
    text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ!",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
  });

  if (!confirm.isConfirmed) {
    setIsDeleting(false);
    return;
  }

  try {
    const result = await apiFetch("/api/farm-area/delete-sub-area", {
      method: "POST",
      body: { area_id: sub_area_id },
    });

    Swal.fire({
      icon: "success",
      title: "‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
      text: result.message || "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
    });

    // üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï farms list
    setFarms((prev) =>
      prev.map((farm) =>
        farm.farm_id === farm_id
          ? {
              ...farm,
              sub_areas: farm.sub_areas.filter(
                (a) => a.area_id !== sub_area_id
              ),
            }
          : farm
      )
    );

    // üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏≠‡∏¢‡∏π‡πà
    setCurrentFarmForSubArea({
      ...currentFarmForSubArea,
      sub_areas: currentFarmForSubArea.sub_areas.filter(
        (a) => a.area_id !== sub_area_id
      ),
    });
  setIsDeleting(true);

  } catch (err) {
    console.error("Delete error:", err);

    Swal.fire({
      icon: "error",
      title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
      text: err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ",
    });

  } finally {
    setIsDeleting(false);
  }
}
