name: Deploy Self-Hosted

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted  # ðŸ‘ˆ à¸ˆà¸¸à¸”à¸ªà¸³à¸„à¸±à¸: à¸šà¸­à¸à¹ƒà¸«à¹‰à¸¡à¸²à¸—à¸³à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸£à¸²à¹€à¸­à¸‡

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy with Docker
        run: |
          # à¸•à¸­à¸™à¸™à¸µà¹‰à¹€à¸£à¸²à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ Server à¹à¸¥à¹‰à¸§ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ SSH
          # à¸¢à¹‰à¸²à¸¢à¹„à¸Ÿà¸¥à¹Œà¸ˆà¸²à¸ Runner à¹„à¸›à¸—à¸µà¹ˆà¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡
          TARGET_DIR="/var/www/html/smart-paddy"
          
          echo "ðŸš€ Copying files to $TARGET_DIR..."
          mkdir -p $TARGET_DIR
          # à¹ƒà¸Šà¹‰ rsync à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¸ˆà¸²à¸à¸ˆà¸¸à¸”à¸—à¸µà¹ˆ Runner à¸­à¸¢à¸¹à¹ˆ à¹„à¸›à¸—à¸µà¹ˆà¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡
          rsync -avz --exclude '.git' --exclude 'node_modules' --exclude '.next' ./ $TARGET_DIR

          # à¹€à¸‚à¹‰à¸²à¹„à¸›à¸ªà¸±à¹ˆà¸‡ Docker
          echo "ðŸ³ Building Docker..."
          cd $TARGET_DIR/web
          
          # à¸–à¹‰à¸²à¸¡à¸µà¹„à¸Ÿà¸¥à¹Œ .env à¸•à¹‰à¸­à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸£à¸‡à¸™à¸µà¹‰ (à¸«à¸£à¸·à¸­à¸ªà¸£à¹‰à¸²à¸‡à¸—à¸´à¹‰à¸‡à¹„à¸§à¹‰à¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹à¸¥à¹‰à¸§à¸à¹‡à¹„à¸”à¹‰)
          # echo "DATABASE_URL=..." > .env 

          docker compose down
          docker compose up -d --build
          docker image prune -f
          
          echo "âœ… Deployment Successful!"
